<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Estimasi Konstruksi Terpadu</title>
    
    <style>
        /* RESET & BASE */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f4f6f7; color: #2c3e50; }
        * { box-sizing: border-box; }
        
        /* LAYOUT UTAMA */
        .sidebar { position: fixed; left: 0; top: 0; height: 100%; width: 220px; background: #2c3e50; padding-top: 20px; z-index: 1000; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .app-container { margin-left: 220px; padding: 20px; min-height: 100vh; }
        
        /* NAVIGASI */
        .nav-btn { display: block; width: 90%; margin: 10px auto; padding: 12px 15px; border: none; background: #34495e; color: #ecf0f1; text-align: left; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
        .nav-btn:hover { background: #3e5871; transform: translateX(2px); }
        .nav-btn.active { background: #3498db; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        /* HEADER */
        .app-header { background: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .app-header h1 { margin: 0; font-size: 1.5rem; color: #2c3e50; }
        .header-total { font-size: 1.2rem; font-weight: bold; color: #27ae60; background: #eafaf1; padding: 8px 15px; border-radius: 20px; border: 1px solid #d5f5e3; }

        /* INPUT CONTROLS */
        .controls, .controls-denah { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .input-wrap label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; color: #7f8c8d; }
        .input-wrap input, .input-wrap select { width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 5px; font-size: 14px; transition: 0.2s; }
        .input-wrap input:focus, .input-wrap select:focus { border-color: #3498db; outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }

        /* TABLE */
        .table-responsive { background: white; padding: 0; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px 15px; text-align: left; color: #2c3e50; border-bottom: 2px solid #e9ecef; font-weight: 600; }
        td { padding: 10px 15px; border-bottom: 1px solid #f1f1f1; color: #555; vertical-align: middle; }
        tr:hover { background-color: #fbfbfb; }
        
        /* TOMBOL */
        .btn-group button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-right: 10px; transition: 0.2s; }
        #btn-calc { background: #e67e22; color: white; }
        #btn-calc:hover { background: #d35400; }
        #btn-calc:disabled { background: #95a5a6; cursor: not-allowed; }
        .btn-export { background: #27ae60; color: white; }
        
        /* CANVAS AREA (PENTING UNTUK DENAH) */
        .canvas-wrapper { text-align: center; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; overflow: hidden; position: relative; }
        canvas { box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: grab; }
        
        /* LOADER OVERLAY */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* PRINT MODE */
        @media print {
            .sidebar, .no-print, .controls, .btn-group { display: none !important; }
            .app-container { margin: 0; padding: 0; width: 100%; margin-left: 0; }
            .app-header { border-bottom: 2px solid #333; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h3 id="loading-text" style="color:#2c3e50;">Menghubungkan ke Server...</h3>
        <small style="color:#7f8c8d;">Memuat Sistem Estimasi Konstruksi</small>
    </div>

    <div class="sidebar no-print">
        <button onclick="showPage('home')" class="nav-btn active" id="btn-nav-home">üè† Home (RAB)</button>
        <button onclick="showPage('denah')" class="nav-btn" id="btn-nav-denah">üìê Denah 2D</button>
    </div>

    <div class="app-container">
        
        <div id="page-home" class="page-section">
            <div class="app-header">
                <h1>Estimasi Konstruksi Terpadu</h1>
                <div class="header-total no-print" id="txt-grandtotal-top">Rp 0</div>
            </div>

            <div class="controls">
                <div class="grid-inputs">
                    <div class="input-wrap">
                        <label>üè¢ Tipe Bangunan</label>
                        <select id="inp_type" onchange="calculateAuto()">
                            <option value="default">Standar Hunian</option>
                        </select>
                    </div>
                    <div class="input-wrap">
                        <label>üìè Luas Bangunan (m¬≤)</label>
                        <input type="number" id="inp_LB" value="36" oninput="calculateAuto()">
                    </div>
                    <div class="input-wrap">
                        <label>üó∫Ô∏è Luas Tanah (m¬≤)</label>
                        <input type="number" id="inp_LT" value="60" oninput="calculateAuto()">
                    </div>
                    <div class="input-wrap">
                        <label>üì∂ Jumlah Lantai</label>
                        <input type="number" id="inp_floors" value="1" oninput="calculateAuto()">
                    </div>
                    <div class="input-wrap">
                        <label>üöú Kondisi Tanah</label>
                        <select id="inp_soil" onchange="calculateAuto()">
                            <option value="normal">Tanah Stabil</option>
                            <option value="soft">Tanah Lunak</option>
                            <option value="peat">Gambut</option>
                        </select>
                    </div>
                    <div class="input-wrap">
                        <label>üèóÔ∏è Metode Pelaksanaan</label>
                        <select id="inp_execution_mode" onchange="calculateAuto()">
                            <option value="borongan_hemat">Borongan Hemat</option>
                            <option value="kontraktor_pro" selected>Kontraktor Pro</option>
                        </select>
                    </div>
                    <div class="input-wrap">
                        <label>üí∞ Target Budget</label>
                        <input type="number" id="inp_target_budget" placeholder="0" oninput="calculateAuto()">
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; border: 1px dashed #ccc; background: #fdfdfd; border-radius: 8px;">
                    <h4 style="margin-top:0;">‚ûï Item Tambahan</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="cust_name" placeholder="Nama Pekerjaan" style="flex: 2;">
                        <input type="number" id="cust_vol" placeholder="Vol" style="width: 70px;">
                        <input type="text" id="cust_sat" placeholder="Sat" style="width: 70px;">
                        <input type="number" id="cust_price" placeholder="Harga" style="flex: 1;">
                        <button onclick="addCustomItem()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius:5px; cursor: pointer;">Tambah</button>
                    </div>
                </div>

                <div class="btn-group no-print" style="margin-top: 20px;">
                    <button id="btn-calc" onclick="calculateAuto()" disabled>üîÑ HITUNG RAB</button>
                    <button class="btn-export" onclick="exportToCSV()">üìÑ Simpan CSV</button>
                    <button style="background:#34495e; color:white;" onclick="window.print()">üñ®Ô∏è Print PDF</button>
                </div>
            </div>

            <div id="result-area" class="table-responsive" style="margin-top:20px;">
                <table id="rab-table">
                    <thead>
                        <tr>
                            <th>Aksi</th><th>Kode</th><th>Uraian Pekerjaan</th><th style="text-align:center;">Vol</th><th style="text-align:center;">Sat</th><th style="text-align:right;">Harga</th><th style="text-align:right;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="7" style="text-align:center; padding:20px;"><i>Data belum dihitung. Klik 'HITUNG RAB'.</i></td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="footer-summary" style="margin-top:20px; text-align:right; padding-right:20px;">
                <h3>GRAND TOTAL: <span id="txt-grandtotal">Rp 0</span></h3>
            </div>
        </div>

        <div id="page-denah" class="page-section" style="display:none;">
            <div class="app-header">
                <h1>üìê Smart Architect (Grid 100m)</h1>
            </div>

            <div class="controls-denah">
                <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                    <input type="text" id="inp_room_name" placeholder="Nama Ruang" style="width:120px;">
                    <select id="inp_room_type">
                        <option value="bedroom">Kamar Tidur</option>
                        <option value="wc">WC/Toilet</option>
                        <option value="living">R. Tamu</option>
                        <option value="kitchen">Dapur</option>
                        <option value="garden">Taman</option>
                    </select>
                    <input type="number" id="inp_room_w" value="3" placeholder="P" style="width:60px;">
                    <input type="number" id="inp_room_h" value="3" placeholder="L" style="width:60px;">
                    <button onclick="addRoomManual()" style="background:#2980b9; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;">+ Ruangan</button>
                    <button onclick="optimizeLayout()" style="background:#27ae60; color:white; border:none; padding:10px 15px; border-radius:5px; cursor:pointer;">‚ö° Auto-Layout</button>
                </div>
            </div>

            <div class="canvas-wrapper">
                <canvas id="canvas2d" width="800" height="500"></canvas>
                <div id="denah-info-panel" style="margin-top:10px; color:#7f8c8d; font-size:0.9rem;"></div>
            </div>
        </div>

    </div>

    <script>
        function showPage(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.style.display = 'none');
            document.getElementById('page-' + pageId).style.display = 'block';
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-nav-' + pageId).classList.add('active');
            
            if(pageId === 'denah' && window.Engine_Architect) {
                setTimeout(() => window.Engine_Architect.draw(), 100);
            }
        }
    </script>

    <script>
      const BASE_REPO = "https://raw.githubusercontent.com/freddyhutauruk18-cpu/rab/main/";

      const jsFiles = [
        "config.js", "init.js", "core_models.js", "building_types.js", 
        "types_business.js", "types_housing.js", "types_industrial.js", "types_special.js",
        "engine_calc.js", "engine_architect.js", "engine_furniture.js",
        "ui_renderer.js", "app_search.js", "app_controller.js", "app_init.js"
      ];

      const ahspFiles = [
        "AHSP-01", "AHSP-02", "AHSP-03", "AHSP-04", "AHSP-05", "AHSP-06", "AHSP-07", 
        "AHSP-08", "AHSP-09", "AHSP-10", "AHSP-11", "AHSP-12", "AHSP-13", "AHSP-14", 
        "AHSP-15", "AHSP-16", "AHSP-17", "AHSP-18", "AHSP-19", "AHSP-20"
      ];

      async function bootSystem() {
        const txt = document.getElementById('loading-text');
        console.log("üöÄ Booting System...");

        try {
          // 1. Load Scripts
          for (const file of jsFiles) {
            txt.innerText = "Memuat Modul: " + file;
            await loadScript(BASE_REPO + file);
          }

          // 2. Fetch Data AHSP
          txt.innerText = "Mengunduh Database Harga...";
          window.DATABASE = [];
          
          let fetchPromises = ahspFiles.map(file => fetch(BASE_REPO + file).then(res => res.json()));
          let results = await Promise.all(fetchPromises);
          
          results.forEach(json => {
            if(json.items) window.DATABASE.push(...json.items);
          });
          
          console.log(`‚úÖ Database Siap! Total: ${window.DATABASE.length} item.`);
          
          // 3. Finish
          document.getElementById('loading-overlay').style.opacity = '0';
          setTimeout(() => {
             document.getElementById('loading-overlay').style.display = 'none';
          }, 500);

        } catch (error) {
          console.error("‚ùå Error:", error);
          txt.innerHTML = "Gagal Memuat: " + error.message;
          txt.style.color = "red";
        }
      }

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          let s = document.createElement("script");
          s.src = src;
          s.onload = resolve;
          s.onerror = reject;
          document.body.appendChild(s);
        });
      }

      bootSystem();
    </script>

</body>
</html>
